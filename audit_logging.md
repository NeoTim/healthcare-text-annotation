# Audit Logging

This doc: go/hcls-audit

<!--*
# Document freshness: For more information, see go/fresh-source.
freshness: { owner: 'jiahuay' reviewed: '2020-07-10' }
*-->

[TOC]

## Design documents

*   CHC Gin auditing: http://go/healthcare-gin-prd
*   CHC Audit logging PRD: http://go/healthcare-audit-prd
*   CLS Audit logging PRD: go/cls-stackdriver-prd

## Overview

The HCLS APIs are integrated with cloud audit logging(go/cloudauditlogs) and gin
logging(go/gin). See g3doc/google/cloud/audit/g3doc/site/faq for the difference
between them.

We integrate with Cloud Audit Logging service in two ways

-   Through ESF go/cal-integ#esf-coding,
    [code](https://source.corp.google.com/piper///depot/google3/cloud/healthcare/aaa/audit.go)
-   Direct write to CAL through envelope go/cal-integ#non-esf-coding,
    [code](https://source.corp.google.com/piper///depot/google3/cloud/healthcare/aaa/envelopeaudit.go)

We also integrate with Gin Logging service in two ways

-   Through ESF go/gcp-gin-esf,
    [code](https://source.corp.google.com/piper///depot/google3/cloud/healthcare/aaa/audit.go)
-   Direct write to Gin logging service
    [code](https://source.corp.google.com/piper///depot/google3/cloud/healthcare/backends/gin/provider.go;bpv=1;bpt=1)

## Viewing Cloud Audit Log

### Enable Cloud Audit Logging for Your Project

For a consumer project, data access logs must be
[enabled](https://cloud.google.com/logging/docs/audit/configure-data-access#config-console-enable)
for all audit logs to be generated.

If the project is deployed through the
[Data Protection Toolkit](/cloud/healthcare/g3doc/data_stewardship/how_to/hcls_data_onboarding.md),
audit logging will be enabled as part of the deployment.

### Viewing Cloud Audit Logs {#viewing}

Logs can be viewed in the
[Pantheon UI](https://pantheon.corp.google.com/logs/viewer) once data access
audit logging has been enabled.

NOTE: (b/152313907): the new Stackdriver UI doesn't show logs from non-prod CHC
API. Please switch back to "Classic View" for them to show up.
http://screen/J0DoxOO8GwU.

To view audit logs generated by non-prod CHC APIs, you can either use different
patheon instances or specify different URL parameters.
[More details here](/google/cloud/audit/g3doc/site/faq.md#how-do-i-view-data-in-test-or-staging)

| CHC API     | audit log   | Prod pantheon with sticky flag                   |
: environment : environment :                                                  :
| ----------- | ----------- | ------------------------------------------------ |
| prod        | prod        | http://pantheon/logs/viewer?mods=logs_tg_prod    |
| autopush,   | staging     | http://pantheon/logs/viewer?mods=logs_tg_staging |
: staging     :             :                                                  :
| dev,        | test        | http://pantheon/logs/viewer?mods=logs_tg_test    |
: sandman     :             :                                                  :

In the filters, select the Cloud Healthcare API or the method you want:
![Select 'Audited Resource' in the filters](https://screenshot.googleplex.com/20R7TV4Ji0o.png).

## Cloud Audit Log Integration For New Methods/Services

Follow Phase 2 on go/cal-integ#phase-2 to implement audit logging for new
methods and services. Skip the coding portion since that's handled by the
google3/cloud/healthcare/aaa/ libraries.

### What to Audit Log

Follow go/cal-integ#audit-rules to decide which fields should be annotated for
audit logging.

A field with `AUDIT` annotation will be audit logged only if all its parents
have `AUDIT` annotation. For example, if a proto `Foo` has a field `Bar`, even
though `Bar` has `AUDIT` annotation, it won't be logged if `Foo` doesn't have
one. Same for RPC methods, even if `FooResponse` has `AUDIT` annotation, it
won't be logged in the method `Foo` if the method doesn't log responses (i.e.
`AUDIT_REQUEST_ONLY`) - however, if proto `FooResponse` is also part of a
different method Baz's response, and Baz logs responses, the proto will be
logged there.

NOTE: LROs (long running operations) require extra metadata
([documentation](https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/integration/long-running-operation.md?#start-lro))
at request time, make sure to add them ([example](http://cl/294722975)).

#### RPC methods

We usually use
[`(google.api.method_auditing).directive = "AUDIT_REQUEST_AND_RESPONSE"`](http://google3/google/api/auditing.proto?rcl=217082795&l=103)
or
[AUDIT_REQUEST_ONLY](http://google3/google/api/auditing.proto?rcl=217082795&l=106)
to mark our RPC methods.

All RPC requests should be logged, and we should try to log as many responses as
possible. Here are some special rules:

1.  All `Get*`, `List*`, and `Search*` methods should use `AUDIT_REQUEST_ONLY`,
    according to the instruction
    [here](http://go/cal-privacy-guidelines#request_and_response).
2.  Some operations with very low audit value can omit audit logs using
    [AUDIT_EXEMPTED](http://google3/google/api/auditing.proto?rcl=217082795&l=89),
    some known examples are
    -   [LRO Get/ListOperations](http://go/cal-lro#lro-meta-api)
    -   [TestIAMPermissions](https://docs.google.com/document/d/1HLDwGrOH7AEZsZzc7SXQu8GioFhAEflOPO0CNOnnzNY/edit#heading=h.j64g8uh97r71)
3.  If the response type is know to be NOT audit logged, for example
    `google.api.HttpBody` and `google.protobuf.Empty`, we should use
    `AUDIT_REQUEST_ONLY` to indicate responses are not logged at a higher level.
    -   one exception is `google.longrunning.Operations`, we manually enabled
        logging them in cl/302951717.

#### Proto Fields

We use
[`(google.api.field_auditing).directive = "AUDIT"`](http://google3/google/api/auditing.proto?rcl=217082795&l=61)
to mark proto fields to be audit logged.

We should try to log as many field as possible, as long as they **don't contain
PII/PHI**.

For those fields containing PII/PHI, mark them with `(datapol.semantic_type) =
ST_USER_CONTENT` to automatically avoid any kind of logging (including audit
log). In contrast, if a field is marked as `datapol.semantic_type) =
ST_NOT_REQUIRED`, which means it doesn't contain any PII, we should log them.

Note: `datapol.semantic_type) = ST_NOT_REQUIRED` only serves as a comment and
doesn't enforce anything for audit logging.

For those repeated fields with PII, consider use `AUDIT_SIZE`.

### Testing Cloud Audit Logs

Cloud Audit Logs are covered by
[APISpec](./integration_tests.md?#apispec-cloud-audit) based tests in
integration tests. Submit this test before going for the audit log review.

ESF-based cloud audit logs can be tested in unit tests following
[this example](http://google3/cloud/healthcare/util/testhelpers.go?q="CloudAuditLogEntry")).
If you need help testing envelope-based cloud audit logs, contact hcls-infra@

## Audit Log Review {#review}

The Cloud Healthcare API is already integrated with Cloud Audit Logging, but in
general any new IAM permissions being added require audit logs review before
their permission types (e.g. `type: DATA_READ`) can be added to IAM prod.

### Incremental Audit Logs Review

*   Ensure the permission and type are submitted to iam-staging and rolled out
    (follow go/hcls-iam#update-service-config).
*   Update the top level CHC Audit Logging PRD http://go/chc-audit-prd to
    include your permissions and methods. Use it in your review bug.
*   Generate logs for the new API or feature following the
    [Generate Logs for Review](#generate-logs) section.
*   Create and fill out an incremental log review bug
    [Launch Review bug](https://b.corp.google.com/issues/new?component=863185&template=1430433)
    under the Cloud Platform > Logging > Audit Logging > Incremental component.
    See b/123772870 for an example.
*   Follow the steps in go/cal-integ#logs_review to run the validation tool, and
    attach results to the review bug.
*   The audit logs team will review the generated logs and LGTM or suggest
    changes.

### Generate Logs for Review {#generate-logs}

You can generate the cloud audit logs using the
[Cloud Audit Integration test](https://g3doc.corp.google.com/cloud/healthcare/g3doc/api/integration_tests.md#apispec-cloud-audit)
based on APISpec. The test generates audit log entry for both allowed and denied
cases.

Run the test in CHC autopush environment. For example:

```
google/cloud/healthcare/test/v1alpha2/conformance/dev_run.sh  --target=cloud_audit --env=autopush --extra_test_args=--service=fhir
```

After the test run is complete, follow the link in
[Viewing Audit Logs](#viewing) section to check the generated audit log entries.

Additional Tips

*   If you don't see audit logs generated, follow
    [trouble shooting steps](#troubleshooting).
*   You can also use the CHC dev environment. This allows you to iterate the
    audit log faster. Check the [Viewing Audit Logs](#viewing) section for which
    CAL environment it writes to.
*   Check the audit log validator output before creating an audit logging review
    bug, and fix any validation errors. It's difficult to tell from the
    validation tool if there is permission denied coverage for every method, so
    look at the logs in Pantheon as well.
*   The audit logs validator doesn't support substring matching or regexps on
    most of its parameters, but it does support stackdriver filters using
    `--filter`, which can be used with the full proto field path, e.g.
    `--filter="protoPayload.methodName:google.cloud.healthcare.v1alpha2.hl7v2.Hl7V2Service"`.
    You can use the following parameters for the autopush environment:
    `--resource_names="projects/cloud-healthcare-test"
    --logging_environment="test"
    --service_name="autopush-healthcare.sandbox.googleapis.com"`. Example
    command:

```
/google/data/ro/teams/cloud-logs/validate_audit_logs \
  --logging_environment="staging" \
  --project="cloud-healthcare-test" \
  --service_name="autopush-healthcare.sandbox.googleapis.com" \
  --method_name="google.cloud.location.Locations.GetLocation" \
  --max_entries=100
  --validation_period="1h"
```

<section class="zippy">

#### Generate the logs manually

Audit logs review requires generation of actual audit log events in a test or
staging environment. The [HOWTO
section](https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/integration/howto.md#logs-review-required)
of the Cloud Audit Logging docs covers this, but here are some additional tips
on how to navigate the process:

*   Use the cloud-healthcare-test project, which is already configured to enable
    data access logs.
*   Use service account credentials. To get these credentials, download the
    client key from the test project's service account page on Pantheon, and
    then `oauth2l fetch --json <key file>
    https://www.googleapis.com/auth/cloud-healthcare`.
*   Use curl to send API calls to the autopush environment (unless your service
    requires gRPC). Autopush sends logs to the 'staging' logging environment,
    which can be viewed using the Pantheon instructions above. Dev environments
    are also fine if you need to iterate on the log output.
*   A sample shell script that calls every method:
    [call_all_api.sh](https://cs.corp.google.com/piper///depot/google3/experimental/users/yuxiao/healthcare/audit_logging/api_script/call_all_api.sh?q=call_all_api)
*   You *must* generate a permission denied error for *every* method. A simple
    way to generate permission denied is to use credentials from a service
    account on a different project. The credentials must be valid for the Cloud
    Healthcare API, or a different error will be generated that is not
    sufficient for this review.
*   Permission denied audit log entries (required for the audit log review) will
    not be generated for the called method in cases where the resource path is
    invalid. (e.g. creating a store in an nonexistent dataset or a modifying a
    nonexistent store). These calls will return a permission denied error to the
    client, but will not generate an audit log entry for the method.
*   Audit logs review requires an audit logging PRD for the product, see for
    example [the top-level CHC audit PRD](http://go/chc-audit-prd).

</section>

Reference documentation:

*   [IAM Config CL Review Process](http://go/cal-iam-config-review-process)
*   [Cloud Audit Logging HOWTO](https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/integration/howto.md)
*   [Audit Logging FAQ](https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/faq.md)
*   [Audit Validator Usage](https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/integration/audit-validator-reference.md)
*   [Cloud Audit Logging Privacy Guidelines](http://go/cloud-audit-logging-privacy)

## Backup

Non-test/dev audit logs are backed up into Sawmill for 7 days. A manual
intervention is required to
[replay them upon outage](http://go/audit-logging-client-backup-and-replay-guide#how-to-replay).

See go/audit-logging-client-backup-and-replay-guide for more information.

## FAQs

### Can not generate/see the audit log entry {#troubleshooting}

Check the following steps if you don't see audit log in Pantheon:

-   Pantheon log viewer
    -   You are using the [correct pantheon pantheon link](#viewing) to view the
        logs
    -   You are using the Classic UI (New UI doesn't show non-prod CHC API audit
        log b/152313907). http://screen/J0DoxOO8GwU
-   Consumer project configuration
    -   The consumer project in the request has
        [audit logging enabled](https://cloud.google.com/logging/docs/audit/configure-data-access#config-console-enable)
        for Cloud Healthcare API, for the corresponding log type. See
        [screencast](https://screencast.googleplex.com/cast/NTY1NTA1MzI3NDcxMDAxNnwwZjAxMjZlNS00ZQ)
-   Integration
    -   The IAM Permission has `type` field set in
        [iam-staging](https://source.corp.google.com/piper///depot/google3/configs/storage/zanzibar/staging/iam/healthcare.service)
        and/or
        [iam-prod](https://source.corp.google.com/piper///depot/google3/configs/storage/zanzibar/prod/iam/healthcare.service).
    -   The IAM permission CL has been rolled out. Check
        go/iam-config-rollout-single for status.
    -   The service backend is checking the permission with aaa or newaaa
        library.
-   Request
    -   If the accessed resource doesn't exist, then no audit log entry will be
        genearted, since no request has been sent to IAM service. (Known issue
        tracked with b/151608628)
    -   See go/iam-audit-logging for cases where audit log will be skipped.
-   Still not able to see the resource?
    -   Check the cloud logging team's
        [dashboard](https://pcon.corp.google.com/p#cloud-logs/selectConsole),
        [buganizer](https://b.corp.google.com/savedsearches/5073516) or email
        group (g/cloud-logging-users) to see if there's any recent issue with
        the Cloud Logging serivce, for the environment you are using. See
        [this page](https://g3doc.corp.google.com/cloud/pulse/logging/g3doc/team/users.md#internal-sites)
        for other ways to contact the team.

### authentication_info.principal_email is missing

Check
https://g3doc.corp.google.com/google/cloud/audit/g3doc/site/faq.md#redactions

## Gin logging

Gin annotation guideline: go/gin-annotation-ug

TODO(b/145018938): add gin logging requirements and process.
